# ðŸ“Œ Ultimate In-Depth VESC Parameter Guide

Use Githubâ€™s search to find specific terms like "Field Weakening", "MTPA", "Voltage Cutoff", etc.

Structure for each parameter:
1) What It Does â€“ Short definition.
2) Deeper Insights â€“ Advanced real-world context.
3) How / When to Modify â€“ Practical tuning guidelines.
4) Potential Side Effects â€“ Common pitfalls or issues.

--------------------------------------------------
ðŸ”¹ 1. PWM & COMMUTATION
--------------------------------------------------

ðŸ”§ 1.1 PWM Mode
Param: pwm_mode

What It Does
â€¢ The PWM mode to use for BLDC motors. Synchronous is the most tested and recommended mode. 
â€¢ Possible Values: Nonsynchronous HISW, Synchronous, Bipolar

Deeper Insights
â€¢ Synchronous ensures both high-side and low-side transistors are used in each switching cycle, often giving better efficiency and lower noise. 
â€¢ Nonsynchronous HISW is older: only high-side transistors do PWM, the low-side is fully on or off. 
â€¢ Bipolar is typically for specialized or academic contexts.

How / When to Modify
â€¢ Most modern VESC hardware is stable with Synchronous. 
â€¢ Only choose Nonsynchronous or Bipolar if your hardware or documentation explicitly recommends it.

Potential Side Effects
â€¢ Switching Synchronous â†’ Nonsynchronous can raise MOSFET temperatures or trigger partial conduction issues at certain duty cycles. 
â€¢ Bipolar is untested in many mainstream VESC contexts, so proceed with caution.

--------------------------------------------------

ðŸ”§ 1.2 Commutation Mode
Param: comm_mode

What It Does
â€¢ Used in BLDC sensorless mode to define how zero-cross detection and commutation timing is handled.
â€¢ Values: Integrate, Delay

Deeper Insights
â€¢ Integrate samples back-EMF continuously after a zero crossing, integrating the waveform. More robust at low speed. 
â€¢ Delay is simpler: detect zero-cross, then add a fixed time offset. Itâ€™s less accurate under heavy load.

How / When to Modify
â€¢ Integrate is better for typical e-scooters or e-bikes with frequent low-speed starts.
â€¢ Delay might suffice if your motor rarely sees low RPM or if you prefer a simpler approach.

Potential Side Effects
â€¢ Delay can lead to stuttering at very low speed or heavier loads.
â€¢ Integrate might require more accurate BEMF coupling parameters from detection.

--------------------------------------------------

ðŸ”§ 1.3 Motor Type
Param: motor_type

What It Does
â€¢ Chooses the fundamental commutation approach: BLDC (Trapezoidal), DC (brushed motor), or FOC (Field Oriented Control).

Deeper Insights
â€¢ BLDC = trapezoidal commutation, somewhat louder, slightly less efficient. 
â€¢ DC is only for brushed DC motors. Rare in modern setups. 
â€¢ FOC is advanced: quieter operation, better torque control, supports field weakening & MTPA.

How / When to Modify
â€¢ If the hardware supports it, FOC is usually best for noise & efficiency.
â€¢ BLDC is still used on older or simpler VESC boards.

Potential Side Effects
â€¢ If your ESC canâ€™t handle FOC well, you may see DRV or MOSFET errors at high load or voltage.
â€¢ DC motor mode is irrelevant for typical brushless scooter/e-bike setups.

--------------------------------------------------

ðŸ”§ 1.4 Sensor Mode
Param: sensor_mode

What It Does
â€¢ Applies only in BLDC mode. Chooses between Sensorless, Sensored, or Hybrid (low speed with sensors, high speed sensorless).

Deeper Insights
â€¢ Hybrid = halls at startup, then reverts to sensorless for efficiency. 
â€¢ Pure sensored means halls are used throughout the RPM range. 
â€¢ Sensorless is for motors without sensors or if you prefer no hall wiring.

How / When to Modify
â€¢ For a BLDC build with hall sensors, Hybrid is recommended for smooth takeoff.
â€¢ If no hall sensors exist, sensorless is your only option.

Potential Side Effects
â€¢ Sensorless can cause rough startup on heavy loads.
â€¢ Sensored-only might have overhead or timing offsets at high RPM, but itâ€™s minor in practice.

--------------------------------------------------
ðŸ”¹ 2. CURRENT & BATTERY LIMITS
--------------------------------------------------

ðŸ”§ 2.1 Motor Current Max
Param: l_current_max
What It Does
â€¢ Maximum positive (forward) phase current into the motor. Defines peak torque.

Deeper Insights
â€¢ Phase current can exceed battery current at partial throttle due to duty cycle step-down. 
â€¢ Setting too high can overheat the motor or saturate the ESCâ€™s thermal limits.

How / When to Modify
â€¢ Check motorâ€™s continuous & peak ratings. 
â€¢ Watch motor temperature on test rides before going higher.

Potential Side Effects
â€¢ Excessively high = thermal runaway in motor windings or ESC MOSFET burnouts.
â€¢ Too low = weak acceleration, under-utilized motor.

--------------------------------------------------

ðŸ”§ 2.2 Motor Current Max Brake
Param: l_current_min (negative)

What It Does
â€¢ Maximum negative phase current (braking torque). The energy from braking goes back to the ESC and potentially the battery.

Deeper Insights
â€¢ Large negative phase current can generate very strong braking torque even if your battery regen limit is smaller. The difference is dissipated as heat in MOSFETs.

How / When to Modify
â€¢ Increase negativity if you want stronger e-brake. 
â€¢ If your hardware or motor overheats on repeated downhills, reduce it.

Potential Side Effects
â€¢ Overstress of the ESC if the negative phase current is too high.
â€¢ If battery canâ€™t accept that much regen, you might see BMS cut or overvoltage fault.

--------------------------------------------------

ðŸ”§ 2.3 Battery Current Max
Param: l_in_current_max

What It Does
â€¢ The maximum drawn from the battery side. Major factor in your â€œforwardâ€ power limit.

Deeper Insights
â€¢ This must respect your BMS or cellâ€™s discharge capability (continuous/peak).
â€¢ The battery current is usually lower than the motor current except at high duty cycles.

How / When to Modify
â€¢ If your BMS is rated 60A, set ~60A here.
â€¢ If your battery is large and robust, you can push it higher.

Potential Side Effects
â€¢ Battery or BMS overload if set too high, triggering abrupt BMS cut mid-ride.
â€¢ If set too low, your top speed might still be fine at high duty, but acceleration will be limited.

--------------------------------------------------

ðŸ”§ 2.4 Battery Current Max Regen
Param: l_in_current_min (negative)

What It Does
â€¢ Maximum negative battery current. Limits how much regenerative current is fed back into the battery.

Deeper Insights
â€¢ If your battery can handle 10A charging, set about -10A. 
â€¢ This is separate from motor braking current max: the ESC will limit battery current accordingly.

How / When to Modify
â€¢ If your BMS or cells can handle more charge current, you can set a bigger negative number for stronger regen.
â€¢ If your battery is frequently near full, high regen can cause overvoltage.

Potential Side Effects
â€¢ If set too negative, you risk BMS triggers or cell damage from large charge bursts.
â€¢ If set not negative enough, your regen braking power is minimal.

--------------------------------------------------

ðŸ”§ 2.5 Input Current Limit Map Start
Param: l_in_current_map_start

What It Does
â€¢ Tells the ESC to begin limiting Q-axis current once battery current hits some fraction (like 80â€“90%) of max input current. Default is 1.0 (off).

Deeper Insights
â€¢ Helpful if you do field weakening or MTPA and see battery current overshoots near top speed.
â€¢ E.g., setting 0.8 means at 80% of battery limit, it starts restricting additional torque.

How / When to Modify
â€¢ If your logs show battery current spikes to 100% instantaneously causing oscillation, set around 0.8 or 0.9.
â€¢ If no issues, leaving it at 1 is fine.

Potential Side Effects
â€¢ If set too low, you artificially reduce max power well before full capacity.
â€¢ If set too high, you might see minor current oscillations at top-end.

--------------------------------------------------

ðŸ”§ 2.6 Input Current Map Filter
Param: l_in_current_map_filter

What It Does
â€¢ A filtering constant (0â€“1) that smooths battery current data before applying Q-axis limit in the â€œmap startâ€ feature.

Deeper Insights
â€¢ A smaller number (0.005) = heavier smoothing. 
â€¢ A bigger (0.1) = minimal filtering, more real-time reaction but can be noisy.
How / When to Modify
â€¢ If you see â€œhuntingâ€ or surging at high speed, use heavier filtering (like 0.005â€“0.01).
â€¢ If you need snappier response, go higher.

Potential Side Effects
â€¢ Too much filtering can let short battery spikes slip through.
â€¢ Too little filtering can cause torque pulsing near the limit.

--------------------------------------------------

ðŸ”§ 2.7 Absolute Maximum Current
Param: l_abs_current_max

What It Does
â€¢ A hard fault threshold. If current magnitude exceeds this, the ESC disables output instantly.

Deeper Insights
â€¢ Typically set higher than normal to avoid nuisance trips from short spikes (150â€“300A, for instance).

How / When to Modify
â€¢ If you get random ABS_OVER_CURRENT faults, either raise this or enable slow filtering (l_slow_abs_current).
â€¢ Keep it sufficiently above your normal current to handle transients.

Potential Side Effects
â€¢ Setting it too high can let a real short-circuit go on longer, risking hardware damage.
â€¢ Setting it too low = repeated overcurrent faults on normal spikes.

--------------------------------------------------
ðŸ”¹ 3. RPM & DUTY LIMITS
--------------------------------------------------

ðŸ”§ 3.1 Max ERPM Reverse
Param: l_min_erpm

What It Does
â€¢ Maximum negative electrical RPM if reversing is allowed.

Deeper Insights
â€¢ For no reverse, set 0. 
â€¢ For partial reverse, set a negative eRPM that matches desired reverse speed.

How / When to Modify
â€¢ Most e-scooters do not use reverse: set it 0 if you want to disable reversing. 
â€¢ For small vehicles needing reverse, pick a negative limit aligned with safe speeds.

Potential Side Effects
â€¢ If reversing is enabled but user is unaware, accidental negative throttle can jerk you backward.
â€¢ Large negative eRPM can cause mechanical stress if you force full speed reverse.

--------------------------------------------------

ðŸ”§ 3.2 Max ERPM
Param: l_max_erpm

What It Does
â€¢ The maximum electrical RPM. The ESC enforces a speed cap.

Deeper Insights
â€¢ eRPM = mechanical RPM Ã— number_of_pole_pairs. 
â€¢ E.g., 14 magnet motor => 7 pole pairs, so 6000 mechanical RPM => 42000 eRPM.

How / When to Modify
â€¢ If you want an artificial top-speed limit, reduce it from your default.
â€¢ If you have a large motor that can spin beyond 100k eRPM, set a suitably high number.

Potential Side Effects
â€¢ If too low, youâ€™ll never reach your mechanical potential.
â€¢ Hard limit can feel abrupt if l_erpm_start is high (like 0.95 or 1.0 fraction).

--------------------------------------------------

ðŸ”§ 3.3 ERPM Limit Start
Param: l_erpm_start

What It Does
â€¢ The fraction of l_max_erpm where the current begins to ramp down. So 0.8 means at 80% of max eRPM, torque is gradually limited.

Deeper Insights
â€¢ This yields a soft approach to top speed rather than an abrupt cutoff.

How / When to Modify
â€¢ 0.8 is typical if you want a smoother cap.
â€¢ 1.0 means no soft zone: a harsh limit near max eRPM.

Potential Side Effects
â€¢ If set too low (like 0.5), you lose mid-range power unnecessarily.
â€¢ If set 1.0, the cutoff can be jarring.

--------------------------------------------------

ðŸ”§ 3.4 Max ERPM Full Brake / Max ERPM Full Brake Current Control
Param: l_max_erpm_fbrake, l_max_erpm_fbrake_cc

What It Does
â€¢ BLDC-specific parameters for controlling or disallowing a full brake or direction change below certain ERPM thresholds.

Deeper Insights
â€¢ Typically used if you allow reversing in BLDC mode. 
â€¢ In FOC, these are generally ignored or less relevant.

How / When to Modify
â€¢ If you donâ€™t plan on reversing, default is fine. 
â€¢ If you do reversing, be sure you set safe speeds for direction changes.

Potential Side Effects
â€¢ Setting them too high can let you attempt direction reversals at dangerous speeds in BLDC.

--------------------------------------------------

ðŸ”§ 3.5 Minimum Input Voltage / Maximum Input Voltage
Params: l_min_vin, l_max_vin

What It Does
â€¢ ESC throws fault if supply voltage is below min or above max.

Deeper Insights
â€¢ For 36/42V nominal, a typical max is 57V. 
â€¢ For 72V setups (84V full), you must raise l_max_vin to ~90â€“95V.
How / When to Modify
â€¢ Always match your batteryâ€™s highest charge voltage plus margin.
â€¢ Set l_min_vin slightly below your normal cutoff.

Potential Side Effects
â€¢ If l_max_vin is too low for a 20S battery, youâ€™ll get Over_Voltage fault at full charge.
â€¢ If l_min_vin is too high, you get Under_Voltage cutout even if battery is still partially usable.

--------------------------------------------------

ðŸ”§ 3.6 Battery Voltage Cutoff Start / End
Params: l_battery_cut_start, l_battery_cut_end

What It Does
â€¢ Gradually reduces motor power as voltage nears the cutoff. Full braking is still allowed.

Deeper Insights
â€¢ Example: For 10S Li-ion, set start ~34V, end ~30V. 
â€¢ This helps avoid abrupt BMS cut.

How / When to Modify
â€¢ Base on your cellâ€™s recommended min voltage (like 3.0V/cell for Li-ion).
â€¢ If your BMS cuts at 2.8V/cell, set a slightly higher end for safety.

Potential Side Effects
â€¢ If set too high, you lose performance with significant capacity left.
â€¢ If too low, you risk damaging cells or hitting BMS cutoff anyway.

--------------------------------------------------

ðŸ”§ 3.7 Battery Voltage Regen Cutoff Start / End
Params: l_battery_regen_cut_start, l_battery_regen_cut_end

What It Does
â€¢ Similar concept but for regenerative braking on a full battery to prevent overcharge.

Deeper Insights
â€¢ For a 20S battery (84V fully charged), you might set start=82V, end=84V. 
â€¢ If left default (1000 & 1100), it never triggers, risking overvoltage on steep downhills with full charge.

How / When to Modify
â€¢ Set according to your packâ€™s max voltage. 
â€¢ If you live in hilly areas, ensure this is correct or BMS may force a dangerous cutoff mid-brake.

Potential Side Effects
â€¢ If start is set too low, you rarely get regen. 
â€¢ If not configured, you could blow the BMS or see â€œOverVoltageâ€ faults at full battery.

--------------------------------------------------

ðŸ”§ 3.8 Slow ABS Current Limit
Param: l_slow_abs_current

What It Does
â€¢ Uses a filtered measurement for the absolute max current fault, preventing triggers on very short spikes.

Deeper Insights
â€¢ If you frequently see â€œABS_OVER_CURRENTâ€ on fast throttle changes, this can help.
â€¢ Great for large inductive motors or big short bursts.

How / When to Modify
â€¢ If random overcurrent faults appear with no real sustained high current, enable or keep it on.
â€¢ If you truly want immediate fault on any spike, keep it off.

Potential Side Effects
â€¢ If you rely on the absolute max to protect hardware from short, you might allow small spikes. Usually harmless for typical usage though.

--------------------------------------------------
ðŸ”¹ 4. THERMAL PARAMETERS
--------------------------------------------------

ðŸ”§ 4.1 MOSFET Temp Cutoff Start / End
Params: l_temp_fet_start, l_temp_fet_end

What It Does
â€¢ The ESC reduces output current once the MOSFET temperature hits â€œstartâ€, fully shutting down or faulting at â€œendâ€.

Deeper Insights
â€¢ Default often 85Â°C start, 100Â°C end. Some hardware can go 110â€“120Â°C safely, verify specs.

How / When to Modify
â€¢ If you have big heatsinks or forced cooling, you can push it higher (90/110).
â€¢ In hot climates or limited cooling, keep a safer margin.

Potential Side Effects
â€¢ Setting too high can degrade MOSFETs or let them approach meltdown. 
â€¢ Setting too low leads to frequent thermal throttling when it might still be safe.

--------------------------------------------------

ðŸ”§ 4.2 Motor Temp Cutoff Start / End
Params: l_temp_motor_start, l_temp_motor_end

What It Does
â€¢ If the motor has a temperature sensor, it lowers motor current at start, then full fault at end.

Deeper Insights
â€¢ Some motors have an NTC (10k or 100k) or PTC sensor. Others have none, so these do nothing.
â€¢ Typical start ~85Â°C, end ~100Â°C or 110Â°C, depending on magnet grade.

How / When to Modify
â€¢ If your motor is high-grade (120Â°C capable), you can set 100â€“120Â°C as the end.
â€¢ Watch logs to see if you approach these thresholds.
Potential Side Effects
â€¢ If set incorrectly low, you lose power even though the motor can handle more.
â€¢ If set too high, you risk permanent magnet damage or winding insulation issues.

--------------------------------------------------

ðŸ”§ 4.3 Acceleration Temperature Decrease
Param: l_temp_accel_dec

What It Does
â€¢ Decrease MOSFET/motor temperature limits by a percentage during acceleration, preserving some headroom for braking torque.

Deeper Insights
â€¢ If set to 0.15 (15%), then under acceleration, your 100Â°C limit effectively becomes ~85Â°C. Once you release acceleration, you get full limit again.

How / When to Modify
â€¢ If you do repeated accelerate-brake cycles and want guaranteed braking torque left, keep it around 0.15â€“0.2.
â€¢ If you rarely need that, set 0 for no difference.

Potential Side Effects
â€¢ Too high = acceleration is thermally limited early, sacrificing performance.
â€¢ 0 can lead to strong acceleration but no safety margin for braking if near temp limit.

--------------------------------------------------

ðŸ”§ 4.4 Minimum Duty Cycle / Maximum Duty Cycle
Params: l_min_duty, l_max_duty

What It Does
â€¢ Forces a clamp on the PWM modulation ratio. For instance, max 0.95 means the ESC never hits full 100% duty.

Deeper Insights
â€¢ Some designs do l_max_duty=0.95 or 0.99 to avoid saturating sampling windows.
â€¢ l_min_duty=0.005 is default so you can release to near zero torque.

How / When to Modify
â€¢ If you want maximum possible speed, set ~0.99. Check hardware stability near 100% duty.
â€¢ If motor stalling issues at zero, raising l_min_duty slightly might help.

Potential Side Effects
â€¢ Setting max_duty=1.0 can cause issues with current sampling if your hardware canâ€™t handle near 100% well.
â€¢ High min_duty can produce a â€œpushâ€ at idle, not fully freewheeling.

--------------------------------------------------

ðŸ”§ 4.5 Maximum Wattage / Maximum Braking Wattage
Params: l_watt_max, l_watt_min

What It Does
â€¢ A power-based limit on output or braking. Usually overshadowed by current-based limits.

Deeper Insights
â€¢ Some e-bike regulations want 250W or 750W nominal. This tries to enforce it, but dynamic conditions can still spike currents.
â€¢ If set very high, it effectively does nothing.

How / When to Modify
â€¢ If local laws or personal preferences require a watt cap, set accordingly.
â€¢ If you want no power-based cap, leave them near default (1.5e6 W).

Potential Side Effects
â€¢ Pure watt-limiting can behave oddly with partial duty cycles or hills.
â€¢ If braking wattage is also limited, you might lose needed braking force.

--------------------------------------------------

ðŸ”§ 4.6 Max Current Scale / Min Current Scale
Params: l_current_max_scale, l_current_min_scale

What It Does
â€¢ Multipliers that scale your current limits on-the-fly without rewriting them permanently.

Deeper Insights
â€¢ 1.0 means no scale. 0.5 means half your configured max or min current effectively.

How / When to Modify
â€¢ If you want an â€œeco modeâ€ at half torque, set 0.5. 
â€¢ If you only run one profile, keep it 1.0.

Potential Side Effects
â€¢ Forgetting these are not at 1 can cause confusion about why you have low torque or weak brakes.

--------------------------------------------------

ðŸ”§ 4.7 Duty Cycle Current Limit Start
Param: l_duty_start

What It Does
â€¢ At high duty cycle, the motor can approach battery voltage. This param sets at which duty fraction the ESC starts limiting current.

Deeper Insights
â€¢ 1.0 means no limit. If your hardware or motor saturates near 90â€“95% duty, you might set 0.9 so you never truly saturate.

How / When to Modify
â€¢ If your motor or ESC acts strangely near full duty, set 0.9 or 0.95. 
â€¢ If stable at 100% duty, keep it at 1.0.

Potential Side Effects
â€¢ Lowering it to 0.8 or 0.85 can reduce top-speed torque in that last portion of the duty range.
â€¢ If you do advanced field weakening, you might keep it at 1.0 and let FW handle it.

--------------------------------------------------
ðŸ”¹ 5. BLDC SENSORLESS (BLDC-Mode Specific)
--------------------------------------------------
Many people use FOC, so this is only relevant if you specifically run BLDC sensorless.

ðŸ”§ 5.1 Minimum ERPM, Min ERPM Cycle Int Limit, Max Brake Current at Direction Change
â€¢ Control how the ESC transitions to open-loop or prevents reversing at certain currents in BLDC mode.
â€¢ Typically set automatically or by detection.

Deeper Insights
â€¢ If stuttering at low RPM, experiment with these or re-detect your motor constants.

Potential Side Effects
â€¢ Wrong settings can cause stalling or rough commutation at low speeds.

--------------------------------------------------

ðŸ”§ 5.2 Cycle Integrator Limit, Phase Advance, BEMF Coupling
Params: sl_cycle_int_limit, sl_phase_advance_at_br, sl_bemf_coupling_k, etc.

What They Do
â€¢ Define the zero-cross detection method and commutation timing in BLDC sensorless.

Deeper Insights
â€¢ Usually set by detection. 
â€¢ If you have an unusual motor (very high KV or very low), manual tuning might help.

Potential Side Effects
â€¢ Incorrect values => early or late commutation => large noise, stutter, or poor efficiency.

--------------------------------------------------
ðŸ”¹ 6. FOC PARAMETERS
--------------------------------------------------

ðŸ”§ 6.1 Current KP / KI
Params: foc_current_kp, foc_current_ki

What It Does
â€¢ The D/Q current controller gains in FOC. 
â€¢ Typically found automatically by the â€œdetectionâ€ procedure.

Deeper Insights
â€¢ If KP is too high, you might get overshoot or audible squeals. 
â€¢ If KI is too high, drifting or low-frequency hunting can occur.

How / When to Modify
â€¢ If detection is stable, no need to tweak. 
â€¢ If you see â€œABS OverCurrentâ€ or poor torque response, try lowering KP or re-running detection.

Potential Side Effects
â€¢ Wrong gains = serious stutter, noise, or slow current loop response.

--------------------------------------------------

ðŸ”§ 6.2 Zero Vector Frequency
Param: foc_f_zv

What It Does
â€¢ The fundamental switching frequency for SVM zero vectors in FOC. 
â€¢ Typically 20â€“30 kHz to stay above audible hearing range.

Deeper Insights
â€¢ Going to 30 kHz can make the drive silent but raises switching losses and CPU load.
â€¢ 25 kHz is a common compromise.

How / When to Modify
â€¢ If you hear a whine at 20 kHz, try 30 kHz. 
â€¢ If your hardware overheats at 30 kHz, step down to 20â€“25 kHz.

Potential Side Effects
â€¢ High f_zv => extra MOSFET heat, potential CPU overhead. 
â€¢ Low f_zv => audible noise.

--------------------------------------------------

ðŸ”§ 6.3 Dead Time Compensation
Param: foc_dt_us

What It Does
â€¢ Compensates for the small off period between high and low MOSFET conduction. 
â€¢ Typically ~0.08â€“0.2 Âµs on many designs.

Deeper Insights
â€¢ Proper compensation yields smoother torque at low speed. 
â€¢ Overcompensation can cause negative torque or offset.

How / When to Modify
â€¢ Usually auto-detected or based on hardware suggestions. 
â€¢ If you suspect poor low-speed performance, tweak in small increments.

Potential Side Effects
â€¢ Setting it wrong => stuttering or minor torque inefficiency at very low speeds.

--------------------------------------------------

ðŸ”§ 6.4 Encoder Inverted / Offset / Ratio
Params: foc_encoder_inverted, foc_encoder_offset, foc_encoder_ratio

What It Does
â€¢ For an external encoder (ABI, etc.), define orientation, offset degrees, ratio of mechanical to electrical rotations.

Deeper Insights
â€¢ For a 14-pole motor with an encoder on the shaft, ratio might be 7. 
â€¢ If the motor spins backward, toggling invert or offset can fix it.

How / When to Modify
â€¢ After detection, if the angle is 180Â° off, invert or shift offset. 
â€¢ If a gear is in between, set ratio accordingly.

Potential Side Effects
â€¢ Wrong offset or ratio => the ESC canâ€™t track rotor, leading to stalling or rough motion.

--------------------------------------------------

ðŸ”§ 6.5 Sensor Mode (FOC)
Param: foc_sensor_mode

What It Does
â€¢ For FOC, chooses â€œSensorless, Encoder, Hall Sensors, HFI, VSS, 45 Deg HFI, Coupled HFI,â€ etc.

Deeper Insights
â€¢ Hall Sensors = instant start with no guess. 
â€¢ HFI or VSS helps sensorless start from 0 rpm if the motor has enough saliency.
How / When to Modify
â€¢ If you have physical halls, choose â€œHall Sensors.â€ 
â€¢ If sensorless is desired with high torque from standstill, consider 45 Deg V0V7 HFI or Coupled HFI.

Potential Side Effects
â€¢ HFI is more CPU-intensive and can fail if Ldâ‰ˆLq with low saliency. 
â€¢ Hall-based might skip if the signals are noisy at high speed.

--------------------------------------------------

ðŸ”§ 6.6 Speed Tracker Kp / Ki
Params: foc_pll_kp, foc_pll_ki

What It Does
â€¢ Gains for the speed observer in FOC. Usually 2000 / 30000 by default.

Deeper Insights
â€¢ If you see speed readout delay or overshoot, tweak. 
â€¢ Usually no need to change unless advanced debugging.

How / When to Modify
â€¢ Double or halve them if you suspect observer â€œlagâ€ or â€œnoise.â€

Potential Side Effects
â€¢ Overly big = speed reading hunts or flickers. 
â€¢ Too small = slow response in the speed estimate.

--------------------------------------------------

ðŸ”§ 6.7 Motor Inductance, Lq-Ld Diff, Resistance, Flux Linkage
Params: foc_motor_l, foc_motor_ld_lq_diff, foc_motor_r, foc_motor_flux_linkage

What It Does
â€¢ Fundamental motor parameters for FOC. Usually auto-detected.

Deeper Insights
â€¢ For IPM motors, Ld â‰  Lq. That difference enables MTPA. 
â€¢ If detection is off, you get poor torque or observer misalignment.

How / When to Modify
â€¢ Usually detection is fine. If a weird motor, you might measure manually with â€œmeasure_res/indâ€ in VESC Tool.

Potential Side Effects
â€¢ Wrong values => stuttering, huge current spikes, or inaccurate field weakening behavior.

--------------------------------------------------

ðŸ”§ 6.8 Observer Gain / Slow Gain
Params: foc_observer_gain, foc_observer_gain_slow

What It Does
â€¢ Controls how strongly the sensorless FOC observer tracks rotor angle. 
â€¢ If too high, overshoot. If too low, lag.

Deeper Insights
â€¢ Gains ~ your motorâ€™s L, R, flux. 
â€¢ Lower slow gain can help at low duty cycles.

How / When to Modify
â€¢ If big cogging or losing sync at certain speeds, try halving the main observer_gain. 
â€¢ If everything is stable, no changes needed.

Potential Side Effects
â€¢ Not enough gain => no reliable torque at low speed. 
â€¢ Too much => random current or angle spikes.

--------------------------------------------------

ðŸ”§ 6.9 Duty Downramp Kp / Ki
Params: foc_duty_dowmramp_kp, foc_duty_dowmramp_ki

What It Does
â€¢ In â€œduty cycle modeâ€ (rare usage), prevents current overshoot when throttle is reduced quickly. Not used much in standard current control.

Deeper Insights
â€¢ If purely in â€œcurrent control mode,â€ these might be irrelevant.

How / When to Modify
â€¢ If duty-based control is your mode, adjust to avoid big spikes on throttle release.

Potential Side Effects
â€¢ Overly large gains => slow speed decrease. 
â€¢ Too small => abrupt current surges.

--------------------------------------------------

ðŸ”§ 6.10 Start Current Decrease / Openloop Settings
Params: foc_start_curr_dec, foc_openloop_rpm, etc.

What It Does
â€¢ For sensorless FOC, you can do partial open-loop at start, limiting the current to avoid saturating the observer.

Deeper Insights
â€¢ If your motor saturates easily at 0 rpm, a big current can ruin observer tracking.

How / When to Modify
â€¢ If stalling or big jerk at zero speed, set a start_curr_dec < 1 or add some openloop ramp time.
â€¢ If stable, keep default.

Potential Side Effects
â€¢ Lower start current means weaker launches. 
â€¢ 1.0 means no reduction but might cause stutter at heavy load zero speed.

--------------------------------------------------

ðŸ”§ 6.11 MTPA Algorithm Mode
Param: foc_mtpa_mode

What It Does
â€¢ Allows negative d-axis current for IPM motors, improving torque-per-amp. 
â€¢ Values: Disabled, IQ Target, IQ Measured

Deeper Insights
â€¢ IPM motors have Ld < Lq. MTPA can significantly boost torque. 
â€¢ IQ Measured can be more reactive but noisier.

How / When to Modify
â€¢ If you have a known IPM motor (like many QS hub motors), enable MTPA. 
â€¢ Try IQ Target first, or IQ Measured if transitions feel off.
Potential Side Effects
â€¢ Negative d-current can raise motorâ€™s back-EMF at sudden fault events => high bus voltage risk. 
â€¢ If Ld = Lq, MTPA is pointless.

--------------------------------------------------

ðŸ”§ 6.12 Field Weakening
Params: foc_fw_current_max, foc_fw_duty_start, etc.

What It Does
â€¢ Injects negative d-axis current at high speed to exceed base motor speed. Increases top RPM but with caution.

Deeper Insights
â€¢ Great for â€œoverdriveâ€ ~10â€“30% more speed. 
â€¢ Watch for overvoltage if throttle is cut at high RPM.

How / When to Modify
â€¢ For 5â€“30A FW as a start, set duty_start ~0.9. 
â€¢ Validate logs on actual rides.

Potential Side Effects
â€¢ Excessive FW => bus volt spikes, MOSFET damage, or battery BMS triggers.
â€¢ Motor might overheat if run at high speed heavily.

--------------------------------------------------

ðŸ”§ 6.13 Speed Tracker Position Source
Param: foc_speed_soure

What It Does
â€¢ Position source for the speed trackers: â€œCorrected Positionâ€ vs. â€œObserverâ€ only.

Deeper Insights
â€¢ If you have sensors or HFI, corrected uses that data. 
â€¢ Observer might drift slightly at 0 speed but can be smoother at high speed.

How / When to Modify
â€¢ If you see speed bounce from sensor noise, pick â€œObserver.â€ 
â€¢ If observer lags at very low speed, â€œCorrectedâ€ might help.

Potential Side Effects
â€¢ With poor sensor data, â€œCorrectedâ€ can degrade. 
â€¢ â€œObserverâ€ alone might have small offset at near-zero.

--------------------------------------------------

ðŸ”§ 6.14 Short Low-Side FETs on Zero Duty
Param: foc_short_ls_on_zero_duty

What It Does
â€¢ When duty=0 in FOC, the ESC can short the motor windings via the low-side MOSFETs or leave them open.

Deeper Insights
â€¢ Shorting can create mild braking torque at zero & reduce driver power. 
â€¢ Leaving them open gives freewheel.

How / When to Modify
â€¢ If you want less rolling at 0 throttle, enable short. 
â€¢ If you want free coasting, disable.

Potential Side Effects
â€¢ Could concentrate heat on the low-side MOSFETs. 
â€¢ Slight drag if short is active.

--------------------------------------------------

ðŸ”§ 6.15 Overmodulation Factor
Param: foc_overmod_factor

What It Does
â€¢ Allows SVM to exceed 100% modulation, e.g., hexagonal wave up to 1.15. Gains slight speed without full field weakening.

Deeper Insights
â€¢ 1.0â€“1.15 typical. 
â€¢ 1.15 approaches trapezoidal-like conduction at high speed.

How / When to Modify
â€¢ If you want a small top-speed bump, try 1.05â€“1.10. 
â€¢ At 1.0, no overmod.

Potential Side Effects
â€¢ Slightly rougher waveforms = more motor heat or noise at top speed.

--------------------------------------------------
ðŸ”¹ 7. SPEED & POSITION PID
--------------------------------------------------

ðŸ”§ 7.1 PID Loop Rate
Param: sp_pid_loop_rate

What It Does
â€¢ Rate for position & speed controllers. Values: 25Hz to 10000Hz.

Deeper Insights
â€¢ Higher = more CPU load but faster response. 
â€¢ 250â€“1000Hz is typical for e-scooter.

How / When to Modify
â€¢ If speed-limiting feels laggy, increase. 
â€¢ If CPU is overwhelmed, reduce.

Potential Side Effects
â€¢ Too high => stuttering if CPU canâ€™t keep up.
â€¢ Too low => slow reaction to load changes.

--------------------------------------------------

ðŸ”§ 7.2 Speed PID Kp, Ki, Kd, Filter
Params: s_pid_kp, s_pid_ki, s_pid_kd, s_pid_kd_filter

What It Does
â€¢ The speed controller in VESC, layered over the current controller.

Deeper Insights
â€¢ Usually small because the underlying current loop is already fast. 
â€¢ High Kp can overshoot or surge around target speed.

How / When to Modify
â€¢ If you see big oscillations near set speed, reduce Kp or add Kd. 
â€¢ If itâ€™s too slow to respond to hills, raise Kp/Ki carefully.

Potential Side Effects
â€¢ Excessive gains => jerkiness or noise. 
â€¢ Too low => sluggish speed corrections.

--------------------------------------------------

ðŸ”§ 7.3 Minimum ERPM, Allow Braking, Ramp eRPM
Params: s_pid_min_erpm, s_pid_allow_braking, s_pid_ramp_erpms_s

What It Does
â€¢ Additional rules for speed control: no speed PID below min ERPM, whether braking is permitted, how fast the speed reference can ramp.
Deeper Insights
â€¢ If allow_braking is off, the speed controller never commands negative torque. 
â€¢ Ramp_erpms_s is how quickly the speed setpoint can climb.

How / When to Modify
â€¢ For typical e-scooter usage, keep braking on. 
â€¢ If you want a soft spool-up in speed mode, define a ramp limit (e.g., 25000 erpms/s).

Potential Side Effects
â€¢ Disabling braking in speed PID = no slowing under speed commands, coasts downhill. 
â€¢ Overly small ramp => slow acceleration requests from the speed loop.

--------------------------------------------------

ðŸ”§ 7.4 Speed Source
Param: s_pid_speed_source

What It Does
â€¢ PLL vs. Fast / Faster Estimator for deriving speed in the speed PID.

Deeper Insights
â€¢ PLL is stable but slightly slower. 
â€¢ Fast or Faster can be more immediate but noisier.

How / When to Modify
â€¢ If you want crisp speed-limiting and can handle some noise, pick fast. 
â€¢ If you prefer stable readouts, pick PLL.

Potential Side Effects
â€¢ Too noisy => torque oscillations or speed readout jitter. 
â€¢ Too slow => mild speed-limiting lag.

--------------------------------------------------

ðŸ”§ 7.5 Position PID
Params: p_pid_kp, p_pid_ki, p_pid_kd, etc.

What It Does
â€¢ For servo-like position control applications. Less common for e-scooters.

Deeper Insights
â€¢ Typically used in robotics/CNC. 
â€¢ If you only do speed or current control, you may ignore this.

Potential Side Effects
â€¢ Overly high gains => severe oscillations. 
â€¢ Usually not relevant for normal PEV usage.

--------------------------------------------------
ðŸ”¹ 8. CURRENT CONTROL (BLDC/DC)
--------------------------------------------------

ðŸ”§ 8.1 Startup Boost
Param: cc_startup_boost_duty

What It Does
â€¢ In BLDC/DC current control, itâ€™s the minimum duty fraction when throttle is first engaged, to ensure some torque at zero speed.

Deeper Insights
â€¢ If 0.02, you get a mild â€œjump.â€ 
â€¢ Too high and it can jerk from standstill.

How / When to Modify
â€¢ If your motor has trouble launching from zero, raise slightly. 
â€¢ If you want gentler starts, lower it.

Potential Side Effects
â€¢ Too big => unstoppable jump from standstill. 
â€¢ Too small => possible stalling under load.

--------------------------------------------------

ðŸ”§ 8.2 Minimum Current
Param: cc_min_current

What It Does
â€¢ The threshold below which the ESC stops driving in BLDC/DC current mode, effectively releasing the motor.

Deeper Insights
â€¢ If set 0.1A, you might have a small idle hold. 
â€¢ If 0.01, itâ€™s basically free-coasting under that level.

How / When to Modify
â€¢ If you want a bit of â€œholdâ€ at near-zero throttle, raise. 
â€¢ If you want full freewheel, keep it very low.

Potential Side Effects
â€¢ Larger min current wastes energy or creates mild forward push at minimal throttle.

--------------------------------------------------

ðŸ”§ 8.3 cc_gain, cc_ramp_step_max
â€¢ Additional BLDC/DC current control parameters for ramping the duty cycle under load. 
â€¢ Typically 0.0046 for cc_gain, 0.04 for cc_ramp_step_max.

Deeper Insights
â€¢ If you have a super low inductance motor, you might reduce cc_gain. 
â€¢ If acceleration is jerky, tweak ramp_step.

Potential Side Effects
â€¢ Wrong gain => overshoot or sluggish throttle response in BLDC/DC mode.

--------------------------------------------------

ðŸ”§ 8.4 Fault Stop Time / Duty Ramp Step
Params: m_fault_stop_time_ms, m_duty_ramp_step

What It Does
â€¢ How long the motor is disabled after a fault. 
â€¢ The max ramp step in duty mode for BLDC/DC.

Deeper Insights
â€¢ Typical fault stop is 500 ms. 
â€¢ If you want quick auto-recovery, you can reduce it.

Potential Side Effects
â€¢ Too short => repeated fault triggers rapidly. 
â€¢ Too long => annoying downtime if a minor fault occurs.

--------------------------------------------------
ðŸ”¹ 9. ENCODERS & SENSOR PORTS
--------------------------------------------------

ðŸ”§ 9.1 Encoder Counts, Sin/Cos Gains, Offsets
â€¢ For advanced encoders: specify amplitude ~1.0, offsets ~1.65 V for sin/cos, etc.
â€¢ If you see weird offset, correct it here.

Potential Side Effects
â€¢ Wrong offset => angle errors, stutter. 
â€¢ Wrong amplitude => poor angle resolution.
--------------------------------------------------

ðŸ”§ 9.2 Sensor Port Mode
Param: m_sensor_port_mode

What It Does
â€¢ Mode for the sensor port: Hall, ABI, AS5047, Sin/Cos, TS5700N8501, BISSC, etc.

Deeper Insights
â€¢ Must match your physical sensor wiring or you get garbage signals.

Potential Side Effects
â€¢ If you pick AS5047 but physically have halls, no reading. 
â€¢ Some sensors need advanced or different wiring.

--------------------------------------------------

ðŸ”§ 9.3 Invert Motor Direction
Param: m_invert_direction

What It Does
â€¢ Flips the commanded direction in software. Alternative to swapping two motor phases physically.

Deeper Insights
â€¢ Great if detection found reversed rotation or if dual-motor setups need opposite directions on front vs. rear.

Potential Side Effects
â€¢ If you rely on directional logic for braking or reversing, ensure you also account for inverted direction.

--------------------------------------------------

ðŸ”§ 9.4 DRV8301 OC Mode / DRV8301 OC Adjustment
â€¢ For DRV8301-based hardware, define how hardware overcurrent protection is triggered or latched.
â€¢ Usually "Current Limit" is standard.

Potential Side Effects
â€¢ If the oc_adj is set too low, you get easy fault triggers.
â€¢ If too high, real shorts might not be interrupted fast enough.

--------------------------------------------------

ðŸ”§ 9.5 Min/Max Switching Frequency in BLDC
Params: m_bldc_f_sw_min, m_bldc_f_sw_max

What It Does
â€¢ If using adaptive switching in BLDC, it can move between min & max freq.

Deeper Insights
â€¢ Default range ~3 kHz to 35 kHz. 
â€¢ Lower freq => audible noise, higher => more heat in MOSFETs.

Potential Side Effects
â€¢ Too high freq on old boards => driver errors or MOSFET overheating.

--------------------------------------------------

ðŸ”§ 9.6 Beta Value for Motor Thermistor, etc.
Param: m_ntc_motor_beta, m_ptc_motor_coeff, etc.

What It Does
â€¢ If the motor has an NTC or PTC sensor, set the correct beta or coefficient. 
â€¢ Some motors use KTY or PT1000.

Potential Side Effects
â€¢ Wrong sensor settings => inaccurate temperature reading => poor thermal throttling.

--------------------------------------------------
ðŸ”¹ 10. BMS SETTINGS
--------------------------------------------------

ðŸ”§ 10.1 BMS Type
Param: bms.type

What It Does
â€¢ If using a CAN-based â€œVESC BMS,â€ you can unify data. If none, ignore.

Deeper Insights
â€¢ â€œNoneâ€ means the ESC ignores BMS comm. 
â€¢ â€œVESC BMSâ€ uses messages from the official hardware or similar.

Potential Side Effects
â€¢ If incorrectly enabled, you might see spurious limiting if no real BMS data is present.

--------------------------------------------------

ðŸ”§ 10.2 BMS Limit Mode, Temperature Limit, SOC, VCell Min/Max
Params under bms.*

What It Does
â€¢ The ESC can reduce current smoothly based on batteryâ€™s temperature, SOC, or cell voltages from the BMS over CAN.

Deeper Insights
â€¢ Overtemp or low SOC => input current is scaled down. 
â€¢ This prevents abrupt BMS cut at cell-level constraints.

How / When to Modify
â€¢ If you have an advanced BMS that shares data, set these for gentle limiting. 
â€¢ If your BMS is standalone or simple, these do nothing.

Potential Side Effects
â€¢ If BMS data is invalid or missing, the ESC might clamp power incorrectly. 
â€¢ Misconfigured voltage or SOC limits can hamper performance or cause weird cutouts.

--------------------------------------------------

# WRAP-UP & FINAL NOTES

â€¢ Always Start with Detection: Let the firmware auto-detect motor parameters (R, L, flux, hall table, etc.).
â€¢ Test in Steps: Increase or adjust current limits incrementally, watching temperature logs. 
â€¢ Thermal & Voltage Headroom: Large negative braking or field weakening can produce bus voltage spikes. Ensure safety margins.
â€¢ Hall vs Sensorless vs HFI: 
  - Hall = simpler immediate start,
  - Sensorless/HFI = advanced but can be just as good if tuned well,
  - Keep an eye on noise or offset at high speeds.
â€¢ Smart BMS: If you have a CAN-based BMS, you can coordinate battery info for smooth limiting. If not, the ESC only sees battery voltage and canâ€™t individually protect cell groups.
Ride Safely and enjoy the benefits of a finely tuned VESC-based controller. If something behaves oddly, revert to your last known stable config. Detailed logs are your friend!