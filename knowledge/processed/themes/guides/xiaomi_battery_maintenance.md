# Xiaomi Battery Maintenance & Recovery Playbook

## TL;DR
- **Balance stubborn packs externally before blaming the BMS.** Clip TP4056 or lab-charger leads onto the weakest parallel groups without removing the board—severely unbalanced M365 packs usually recover once every group tops off within a few millivolts.【F:knowledge/notes/all_part01_review.md†L10-L11】
- **Legacy tooling still expects legacy firmware.** Downgrade BLE dashboards to 073/090 so the M365 BMS Tool or ScooterHacking Utility can talk to Rita, Happy BMS, or stock packs without throwing spurious error 21 warnings.【F:knowledge/notes/all_part01_review.md†L12】【F:knowledge/notes/denis_all_part02_review.md†L543-L544】
- **Plan for 30 A-class current, not miracles.** Happy BMS hard-stops around 44 A, Rita beeps at ~30 A, and Xiaomi controllers trip above ~27 A unless reinforced, so size packs, wiring, and brakes for realistic loads rather than marketing fantasy.【F:knowledge/notes/denis_all_part02_review.md†L11-L12】【F:knowledge/notes/all_part01_review.md†L79-L81】【F:knowledge/notes/denis_all_part02_review.md†L73-L74】
- **Charging mods demand instrumentation.** Raising stock chargers to 50.4–54.6 V works, but monitor voltage manually—backfeeding through XT30 bypasses Happy BMS protection, and regen or chargers above 30 A spike Rita or controller MOSFETs.【F:knowledge/notes/all_part01_review.md†L221-L224】【F:knowledge/notes/denis_all_part02_review.md†L185-L186】【F:knowledge/notes/denis_all_part02_review.md†L125-L126】
- **Document every recovery attempt.** Keep an ST-Link v2 on hand, log live current before chasing Rita error 39, and probe MOSFET continuity with packs disconnected to catch shorts before reinstalling a battery.【F:knowledge/notes/all_part01_review.md†L46-L49】【F:knowledge/notes/denis_all_part02_review.md†L55-L57】【F:knowledge/notes/denis_all_part02_review.md†L37-L38】
- **Model upgrades around stock chemistries.** Xiaomi packs usually ship with LG M26 or blue EVE 18650 cells—plan range and sag using those discharge curves rather than assuming MJ1-class performance.【F:knowledge/notes/all_part01_review.md†L88335-L88345】

## Balancing & State-of-Charge Management
| Scenario | Action | Why it Matters |
| --- | --- | --- |
| Pack delta >150 mV | Use TP4056 boards or a bench supply with crocodile clips to top each weak parallel group before reconnecting the charger; leave the BMS in-circuit so protections stay active.【F:knowledge/notes/all_part01_review.md†L10-L11】 | Prevents unnecessary BMS swaps and restores balance after deep storage. |
| Happy BMS pack reads 0 % with energy remaining | Keep riding cautiously—its coulomb counter saturates near 32 Ah but ~3 Ah remain; recalibrate during the next full charge cycle.【F:knowledge/notes/denis_all_part02_review.md†L16-L17】【F:knowledge/notes/denis_all_part02_review.md†L399-L401】 | Avoids panic over false-empty displays on oversized packs. |
| BMS emulation hides error 21 but charger still blinks | Inspect the battery for imbalance instead of reflashing—bypassing the data line never fixes mismatched cell groups.【F:knowledge/notes/denis_all_part02_review.md†L19-L20】 | Prevents overcharging damaged packs behind spoofed telemetry. |
| Cell groups replaced piecemeal | Rebuild the entire pack; mixed-age cells fall out of balance quickly and waste the repair effort.【F:knowledge/notes/denis_all_part02_review.md†L67-L68】 | Ensures parallel groups age uniformly after service. |
| Suspect replacement capacity | Time a full charge with the OEM 1.7 A brick—each hour adds ≈1.7 Ah, so a genuine 12 Ah Pro 2 pack should take close to seven hours from empty.【F:knowledge/notes/denis_all_part02_review.md†L230-L231】 | Confirms marketing claims without opening the case. |
| Charger finishes instantly on a new Happy pack | Wake the BMS with a brief charge pulse; XT60 output remains off until the board sees a charger once.【F:knowledge/notes/denis_all_part02_review.md†L376-L376】 | Prevents unnecessary teardowns when a fresh build appears dead on arrival. |
| Long-term storage | Expect ≈0.6 %/day self-discharge on Happy BMS packs—wake them with a charger pulse before use, park Xiaomi packs around 3.7–3.8 V, and keep them above freezing before charging.【F:knowledge/notes/denis_all_part02_review.md†L479-L481】【F:knowledge/notes/denis_all_part02_review.md†L46-L47】【F:knowledge/notes/all_part01_review.md†L107120-L107130】 | Keeps firmware accurate and cells healthy in winter climates. |

### Temperature Guardrails
- Charge between ~5 °C and 55 °C; brief 28–29 °C top-offs are fine, but let cold-soaked packs warm before plugging in to avoid plating.【F:knowledge/notes/denis_all_part02_review.md†L46-L47】
- When Happy BMS detects ≥40 °C during charging it pauses until the pack cools near 35 °C—provide airflow instead of assuming a fault.【F:knowledge/notes/denis_all_part02_review.md†L316-L316】

## Firmware & Diagnostic Workflow
1. **Restore communications first.** Downgrade BLE, close competing apps, and, if a custom dash sits inline, place it in update mode so Rita/Happy can negotiate over the data line.【F:knowledge/notes/all_part01_review.md†L12】【F:knowledge/notes/all_part01_review.md†L48】
2. **Keep an ST-Link kit.** Four clip leads and the stock firmware image recover most soft-bricked controllers; late G30 dashboards now require ST-Link flashes to bypass OTA locks.【F:knowledge/notes/all_part01_review.md†L46-L49】【F:knowledge/notes/denis_all_part02_review.md†L103-L104】
3. **Probe before power.** With the pack unplugged, meter between battery rails and each phase—anything under ~50 Ω points to a shorted MOSFET that needs replacement before reconnecting cells.【F:knowledge/notes/denis_all_part02_review.md†L37-L38】
4. **Log live current.** Rita error 39 and Happy BMS trips often show up when firmware pulls past ~30 A; capture data with m365Tools or XiaoDash before reducing current limits.【F:knowledge/notes/denis_all_part02_review.md†L55-L57】【F:knowledge/notes/denis_all_part02_review.md†L618-L618】
5. **Respect hall geometry.** Glue replacement sensors exactly where stock ICs sat and retain isolation pads when reassembling heat sinks to avoid losing 10 km/h or shorting MOSFETs to the case.【F:knowledge/notes/denis_all_part02_review.md†L40-L41】

### BMS Reset & Hardware Recovery
- **Use the onboard reset before replacement.** A Pro pack that refuses to charge after overheating often revives by opening the case and pressing the BMS’s tactile button; if LEDs still blink red/green, charge through Rita’s XT30 to confirm whether the internal charge path failed.【F:knowledge/notes/all_part01_review.md†L107001-L107105】
- **Fall back to the XT30 harness when diagnosing.** When the stock charge inlet won’t engage, top the pack via Rita’s XT30 while testing—owners rotate between charge jack and XT30 until a failing BMS or harness is replaced.【F:knowledge/notes/all_part01_review.md†L107545-L107548】【F:knowledge/notes/all_part01_review.md†L107577-L107586】

## Charging & Hardware Upgrades
- **Charger mods:** Swapping the stock feedback network for 14.3 kΩ (e.g., 30 kΩ + 27 kΩ Vishay stack) lifts Xiaomi bricks to 50.4 V for 12 S packs; verify output with a meter before connecting a battery.【F:knowledge/notes/all_part01_review.md†L221-L224】
- **Respect the charge port ceiling:** The factory Xiaomi inlet safely handles ≈3 A; bigger bricks heat the harness unless you upgrade wiring and connectors, so 42 V 3 A chargers remain the practical limit on stock hardware.【F:knowledge/notes/all_part01_review.md†L97910-L97915】
- **Voltage limits:** Happy BMS tolerates 54.6 V chargers on 14 S packs—it simply stops early—while Rita sequences mixed voltages by capping the internal pack around 42 V before finishing the higher-voltage external.【F:knowledge/notes/denis_all_part02_review.md†L345-L345】【F:knowledge/notes/all_part01_review.md†L112-L112】
- **Direct-to-XT30 charging:** Topping a Happy-equipped pack via the controller lead works in emergencies but bypasses over-voltage protection—monitor manually and disconnect once you hit the target voltage.【F:knowledge/notes/denis_all_part02_review.md†L185-L186】
- **Backfeeding depleted packs:** Only nudge a 44 V pack with a 36 V charger when its open-circuit voltage sits under ~41 V; otherwise you risk over-voltage damage.【F:knowledge/notes/denis_all_part02_review.md†L37-L38】
- **Accessory power:** Dashboards expose just 5 V logic—use dedicated DC/DC converters for 12 V lighting, stress-relieve converter leads with RTV or zip ties, and avoid pulling power from charge ports to keep protections intact.【F:knowledge/notes/denis_all_part02_review.md†L28-L32】【F:knowledge/notes/denis_all_part02_review.md†L70-L71】

## Safety & Upgrade Guardrails
- **Pack selection:** Skip unbelievable “13S4P 60 Ah” or €60 “48 V 62 Ah” packs—the chemistry doesn’t exist and bargain controllers rarely survive 48 V; invest in reputable 12–13 S builds instead.【F:knowledge/notes/all_part01_review.md†L39-L40】【F:knowledge/notes/denis_all_part02_review.md†L146-L147】
- **Cell choices:** Refurbished Samsung 35E/50E lots from vetted sellers such as NKON remain viable midlife upgrades—document provenance and avoid mixing them with tired cells from the original pack.【F:knowledge/notes/denis_all_part02_review.md†L224-L225】
- **Brake planning:** 12 S conversions hit ~40 km/h on flat ground—upgrade mechanical brakes and keep regen under ~20 A so Rita and controller FETs stay alive.【F:knowledge/notes/all_part01_review.md†L44-L44】【F:knowledge/notes/all_part01_review.md†L79-L80】
- **Controller heat path:** Torque down stock controllers flush to the chassis with fresh thermal paste; loose mounting or cable stacks overheat MOSFETs on the first long ride.【F:knowledge/notes/denis_all_part02_review.md†L140-L141】
- **Parallel etiquette:** Only parallel packs with matched voltages and common-port BMS boards—Rita and Happy both block or fault when faced with mismatched hardware.【F:knowledge/notes/all_part01_review.md†L102-L113】【F:knowledge/notes/denis_all_part02_review.md†L64-L65】【F:knowledge/notes/denis_all_part02_review.md†L532-L532】
- **LiPo discipline:** RC LiPo bricks puff when stored at full charge and develop high internal resistance within days—treat them as short-term boosters, not daily commuter batteries.【F:knowledge/notes/denis_all_part02_review.md†L158-L159】
- **Respect BMS ceilings.** Even 80 A-capable cells sag and trip protection if the pack still uses a 40 A BMS—raise ratings alongside parallel count to avoid false cut-outs.【F:knowledge/notes/all_part01_review.md†L93571-L93578】
- **Environmental prep:** Seal deck seams, cable ports, and hub joints with silicone plus lithium grease; add humidity sensors or alarms if you commute in heavy rain.【F:knowledge/notes/all_part01_review.md†L41-L41】【F:knowledge/notes/all_part01_review.md†L86-L88】

## Commissioning Checklist
1. **Balance & inspect cells** before closing the pack, replacing entire groups rather than mixing fresh with aged cells.【F:knowledge/notes/all_part01_review.md†L10-L11】【F:knowledge/notes/denis_all_part02_review.md†L67-L68】
2. **Update firmware and dashboards** with BLE downgrades, ST-Link backups, and Rita/Happy configuration before connecting higher-voltage packs.【F:knowledge/notes/all_part01_review.md†L46-L49】【F:knowledge/notes/all_part01_review.md†L119-L119】
3. **Set conservative current limits:** cap battery current ≈25–28 A, regen below 20 A, and confirm logs show <30 A through Rita or Happy BMS during shakedowns.【F:knowledge/notes/all_part01_review.md†L79-L81】【F:knowledge/notes/denis_all_part02_review.md†L55-L57】
4. **Validate charging paths**—meter chargers after resistor swaps, confirm Happy BMS accepts the amperage limit you expect, and never rely on charge-port power for accessories.【F:knowledge/notes/all_part01_review.md†L221-L224】【F:knowledge/notes/denis_all_part02_review.md†L476-L477】【F:knowledge/notes/denis_all_part02_review.md†L70-L71】
5. **Log first rides** with m365Tools or XiaoDash, watching pack temperature, voltage sag, and current spikes so you can dial back settings before hardware fails.【F:knowledge/notes/all_part01_review.md†L105-L105】【F:knowledge/notes/denis_all_part02_review.md†L55-L57】
