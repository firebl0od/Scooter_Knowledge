# Xiaomi Battery Maintenance & Recovery Playbook

## TL;DR
- **Balance stubborn packs externally before blaming the BMS.** Clip TP4056 or lab-charger leads onto the weakest parallel groups without removing the board—severely unbalanced M365 packs usually recover once every group tops off within a few millivolts.【F:knowledge/notes/all_part01_review.md†L10-L11】
- **Legacy tooling still expects legacy firmware.** Downgrade BLE dashboards to 073/090 so the M365 BMS Tool or ScooterHacking Utility can talk to Rita, Happy BMS, or stock packs without throwing spurious error 21 warnings.【F:knowledge/notes/all_part01_review.md†L12】【F:knowledge/notes/denis_all_part02_review.md†L543-L544】
- **Plan for 30 A-class current, not miracles.** Happy BMS hard-stops around 44 A, Rita beeps at ~30 A, and Xiaomi controllers trip above ~27 A unless reinforced, so size packs, wiring, and brakes for realistic loads rather than marketing fantasy.【F:knowledge/notes/denis_all_part02_review.md†L11-L12】【F:knowledge/notes/all_part01_review.md†L79-L81】【F:knowledge/notes/denis_all_part02_review.md†L73-L74】
- **Charging mods demand instrumentation.** Raising stock chargers to 50.4–54.6 V works, but monitor voltage manually—backfeeding through XT30 bypasses Happy BMS protection, and regen or chargers above 30 A spike Rita or controller MOSFETs.【F:knowledge/notes/all_part01_review.md†L221-L224】【F:knowledge/notes/denis_all_part02_review.md†L185-L186】【F:knowledge/notes/denis_all_part02_review.md†L125-L126】
- **Document every recovery attempt.** Keep an ST-Link v2 on hand, log live current before chasing Rita error 39, and probe MOSFET continuity with packs disconnected to catch shorts before reinstalling a battery.【F:knowledge/notes/all_part01_review.md†L46-L49】【F:knowledge/notes/denis_all_part02_review.md†L55-L57】【F:knowledge/notes/denis_all_part02_review.md†L37-L38】
- **Model upgrades around stock chemistries.** Xiaomi packs usually ship with LG M26 or blue EVE 18650 cells—plan range and sag using those discharge curves rather than assuming MJ1-class performance.【F:knowledge/notes/all_part01_review.md†L88335-L88345】

## Balancing & State-of-Charge Management
| Scenario | Action | Why it Matters |
| --- | --- | --- |
| Pack delta >150 mV | Use TP4056 boards or a bench supply with crocodile clips to top each weak parallel group before reconnecting the charger; leave the BMS in-circuit so protections stay active.【F:knowledge/notes/all_part01_review.md†L10-L11】 | Prevents unnecessary BMS swaps and restores balance after deep storage. |
| Happy BMS pack reads 0 % with energy remaining | Keep riding cautiously—its coulomb counter saturates near 32 Ah but ~3 Ah remain; recalibrate during the next full charge cycle.【F:knowledge/notes/denis_all_part02_review.md†L16-L17】【F:knowledge/notes/denis_all_part02_review.md†L399-L401】 | Avoids panic over false-empty displays on oversized packs. |
| Dash shows ≈91 % at 50.1 V on a 12S pack | Treat it as a UI quirk—the pack is effectively full even though the percentage lags. | Prevents unnecessary troubleshooting when full-charge voltage already confirms capacity.【F:knowledge/notes/all_part01_review.md†L361-L361】 |
| Pack rests around 3.0–3.3 V per cell and refuses to charge | Treat the cutoff as normal Happy/Ninebot protection; bring voltage up gently and resume balancing before chasing a BMS replacement.【F:knowledge/notes/denis_all_part02_review.md†L101-L101】 | Prevents unnecessary board swaps when the pack simply hit its low-voltage guardrail. |
| BMS emulation hides error 21 but charger still blinks | Inspect the battery for imbalance instead of reflashing—bypassing the data line never fixes mismatched cell groups.【F:knowledge/notes/denis_all_part02_review.md†L19-L20】 | Prevents overcharging damaged packs behind spoofed telemetry. |
| Cell groups replaced piecemeal | Rebuild the entire pack; mixed-age cells fall out of balance quickly and waste the repair effort.【F:knowledge/notes/denis_all_part02_review.md†L67-L68】 | Ensures parallel groups age uniformly after service. |
| External tops off while the internal pack refuses to charge | Failed OEM temperature sensors often lock the stock BMS; disconnect Rita, test both probes, and replace the bad sensor before condemning the adapter.【F:knowledge/notes/denis_all_part02_review.md†L505-L505】 | Restores normal charge sharing without unnecessary adapter swaps. |
| Suspect replacement capacity | Time a full charge with the OEM 1.7 A brick—each hour adds ≈1.7 Ah, so a genuine 12 Ah Pro 2 pack should take close to seven hours from empty.【F:data/E-scooter upgrade workshop by denis yurev/text_slices/all.part02.txt†L98595-L98598】 | Confirms marketing claims without opening the case. |
| Charger finishes instantly on a new Happy pack | Wake the BMS with a brief charge pulse; XT60 output remains off until the board sees a charger once.【F:knowledge/notes/denis_all_part02_review.md†L376-L376】 | Prevents unnecessary teardowns when a fresh build appears dead on arrival. |
| Long-term storage | Expect ≈0.6 %/day self-discharge on Happy BMS packs—wake them with a charger pulse before use, park Xiaomi packs around 3.7–3.8 V, and keep them above freezing before charging.【F:knowledge/notes/denis_all_part02_review.md†L479-L481】【F:knowledge/notes/denis_all_part02_review.md†L46-L47】【F:knowledge/notes/all_part01_review.md†L107120-L107130】 | Keeps firmware accurate and cells healthy in winter climates. |
| Emulator shows “empty” near 3.4 V/cell | Treat the warning as conservative—Rita-compatible emulators still shout 0 % even with cutoff set lower, so keep manual voltage checks or a buffer when riding on emulation alone.【F:knowledge/notes/denis_all_part02_review.md†L402-L402】 | Avoids unnecessary rescues when plenty of voltage remains. |

### Temperature Guardrails
- Charge between ~5 °C and 55 °C; brief 28–29 °C top-offs are fine, but let cold-soaked packs warm before plugging in to avoid plating.【F:knowledge/notes/denis_all_part02_review.md†L46-L47】
- When Happy BMS detects ≥40 °C during charging it pauses until the pack cools near 35 °C—provide airflow instead of assuming a fault.【F:knowledge/notes/denis_all_part02_review.md†L316-L316】
- Winter commutes can double energy use (~30 Wh/km vs. 18–20 Wh/km); keep packs warm indoors or add gentle heaters so cold batteries deliver rated capacity.【F:knowledge/notes/denis_all_part02_review.md†L161-L165】

### Water Intrusion & Corrosion Checks
- Water-damaged M365 packs often recover after flushing the BMS with isopropyl alcohol; if telemetry still misreports, Denis keeps compatible replacements ready.【F:knowledge/notes/all_part01_review.md†L155-L155】
- Error 28 beeps often trace to a shorted high-side MOSFET after water ingress; repeated wet/dry cycles leave pink stickers and white corrosion, so swap the controller instead of chasing intermittent faults.【F:knowledge/notes/denis_all_part02_review.md†L307-L308】
- Power resets and false-low battery readings usually come from oxidation under the white battery plug—flush with contact cleaner, dry thoroughly, and improve sealing before riding in rain again.【F:knowledge/notes/denis_all_part02_review.md†L309-L309】

## Firmware & Diagnostic Workflow
1. **Restore communications first.** Downgrade BLE, close competing apps, and, if a custom dash sits inline, place it in update mode so Rita/Happy can negotiate over the data line.【F:knowledge/notes/all_part01_review.md†L12】【F:knowledge/notes/all_part01_review.md†L48】
2. **Keep an ST-Link kit.** Four clip leads and the stock firmware image recover most soft-bricked controllers; late G30 dashboards now require ST-Link flashes to bypass OTA locks.【F:knowledge/notes/all_part01_review.md†L46-L49】【F:knowledge/notes/denis_all_part02_review.md†L103-L104】
3. **Rescue Mi3 dashboards with legacy firmware.** When BMS Tool refuses to connect, flash DRV016 alongside NGFW’s model-lock removal via Scooter Hacking Utility and source matching BLE files from mp365.es until broader support lands.【F:knowledge/notes/denis_all_part02_review.md†L85-L86】
4. **Probe before power.** With the pack unplugged, meter between battery rails and each phase—anything under ~50 Ω points to a shorted MOSFET that needs replacement before reconnecting cells.【F:knowledge/notes/denis_all_part02_review.md†L37-L38】
5. **Log live current.** Rita error 39 and Happy BMS trips often show up when firmware pulls past ~30 A; capture data with m365Tools or XiaoDash before reducing current limits.【F:knowledge/notes/denis_all_part02_review.md†L55-L57】【F:knowledge/notes/denis_all_part02_review.md†L618-L618】
6. **Respect hall geometry.** Glue replacement sensors exactly where stock ICs sat and retain isolation pads when reassembling heat sinks to avoid losing 10 km/h or shorting MOSFETs to the case.【F:knowledge/notes/denis_all_part02_review.md†L40-L41】

### BMS Reset & Hardware Recovery
- **Use the onboard reset before replacement.** A Pro pack that refuses to charge after overheating often revives by opening the case and pressing the BMS’s tactile button; if LEDs still blink red/green, charge through Rita’s XT30 to confirm whether the internal charge path failed.【F:knowledge/notes/all_part01_review.md†L107001-L107105】
- **Fall back to the XT30 harness when diagnosing.** When the stock charge inlet won’t engage, top the pack via Rita’s XT30 while testing—owners rotate between charge jack and XT30 until a failing BMS or harness is replaced.【F:knowledge/notes/all_part01_review.md†L107545-L107548】【F:knowledge/notes/all_part01_review.md†L107577-L107586】
- **Split factory shells methodically.** Slice both bottom seams, warm the glue, and drift the brick out before metering CF-series capacitors—imbalances often trace back to failed caps that should read infinite resistance.【F:knowledge/notes/denis_all_part02_review.md†L496-L497】

## Charging & Hardware Upgrades
- **Charger mods:** Swapping the stock TL431 feedback network (e.g., two 33 kΩ plus 100 kΩ with a 16 kΩ 0805) and upgrading output capacitors to 100 V lifts Xiaomi bricks toward 57.5 V; meter the result before plugging into a pack.【F:knowledge/notes/denis_all_part02_review.md†L585-L586】【F:knowledge/notes/all_part01_review.md†L221-L224】
- **Respect the charge port ceiling:** The factory Xiaomi inlet safely handles ≈3 A; bigger bricks heat the harness unless you upgrade wiring and connectors, so 42 V 3 A chargers remain the practical limit on stock hardware.【F:knowledge/notes/all_part01_review.md†L97910-L97915】
- **Refresh tired charge leads before blaming the jack.** A “burned” 3 A port turned out to have cooked wiring—replace the short pigtail with heavier (~24 AWG) leads and inspect the socket for looseness once plastic melts.【F:knowledge/notes/denis_all_part02_review.md†L399-L400】
- **Upgrade charge connectors when raising current:** Swap the slim JST input for XT30/XT60 or XT90S hardware before running 5 A chargers, solder and heat-shrink every joint, and keep JST-only harnesses below ≈3 A even when paralleled for balancing.【F:knowledge/notes/denis_all_part02_review.md†L510-L510】【F:knowledge/notes/denis_all_part02_review.md†L540-L541】
- **Tame DC step-up chargers:** Start with output voltage below pack voltage, connect, then ramp to ≈1 A before adjusting the current-limit pot to avoid sparks and overheated LEDs.【F:knowledge/notes/denis_all_part02_review.md†L537-L537】
- **Trust vetted CC/CV bricks:** Anonymous “48 V” chargers frequently skip documented CC/CV stages; the workshop sticks with YZPOWER 13 S supplies and soldered connector swaps instead of taped adapters.【F:knowledge/notes/denis_all_part02_review.md†L598-L600】
- **Raise Happy BMS charge ceilings before using 5 A bricks:** Stock firmware blocks chargers above ~3 A; increase the limit to ~5.5 A in Embedden BMS Tool so Rita’s harness survives heavier charging.【F:knowledge/notes/denis_all_part02_review.md†L476-L476】
- **Voltage limits:** Happy BMS tolerates 54.6 V chargers on 14 S packs—it simply stops early—while Rita sequences mixed voltages by capping the internal pack around 42 V before finishing the higher-voltage external.【F:knowledge/notes/denis_all_part02_review.md†L345-L345】【F:knowledge/notes/all_part01_review.md†L112-L112】
- **Direct-to-XT30 charging:** Topping a Happy-equipped pack via the controller lead works in emergencies but bypasses over-voltage protection—monitor manually and disconnect once you hit the target voltage.【F:knowledge/notes/denis_all_part02_review.md†L185-L186】
- **Backfeeding depleted packs:** Only nudge a 44 V pack with a 36 V charger when its open-circuit voltage sits under ~41 V; otherwise you risk over-voltage damage.【F:knowledge/notes/denis_all_part02_review.md†L37-L38】
- **Accessory power:** Dashboards expose just 5 V logic—use dedicated DC/DC converters for 12 V lighting, stress-relieve converter leads with RTV or zip ties, and avoid pulling power from charge ports to keep protections intact.【F:knowledge/notes/denis_all_part02_review.md†L28-L32】【F:knowledge/notes/denis_all_part02_review.md†L70-L71】
- **Step-down LED strips:** Most consumer LED kits are rated ≤24 V; use a buck converter when tapping scooter packs because direct 36 V feeds cook the strip and risk shorts.【F:knowledge/notes/all_part01_review.md†L156-L156】
- **Swap flaky “purple” dashboards:** If headlights sag throttle voltage and cap speed, replace the dash—regen current into 36–40 V lamps is safe, but faulty boards throttle output under load.【F:knowledge/notes/denis_all_part02_review.md†L486-L487】

## Safety & Upgrade Guardrails
- **Pack selection:** Skip unbelievable “13S4P 60 Ah” or €60 “48 V 62 Ah” packs—the chemistry doesn’t exist and bargain controllers rarely survive 48 V; invest in reputable 12–13 S builds instead.【F:knowledge/notes/all_part01_review.md†L39-L40】【F:knowledge/notes/denis_all_part02_review.md†L146-L147】
- **Treat “fire emoji” AliExpress packs as suspect.** Riders keep finding laptop-pull bricks that sag early—Denis caps Happy BMS builds near 53 V/40 A and leans on refurbished OEM modules instead of forcing Rita past spec.【F:knowledge/notes/denis_all_part02_review.md†L458-L459】
- **Cell choices:** Refurbished Samsung 35E/50E lots from vetted sellers such as NKON remain viable midlife upgrades—document provenance and avoid mixing them with tired cells from the original pack.【F:data/E-scooter upgrade workshop by denis yurev/text_slices/all.part02.txt†L97241-L97259】
- **Know pouch-cell trade-offs.** Cylindrical cells tend to fail open when abused, while pouch cells demand constant compression and can vent violently if overcharged—reserve pouch experiments for builders with proper fixtures and monitoring.【F:data/E-scooter upgrade workshop by denis yurev/text_slices/all.part02.txt†L97241-L97259】
- **Respect chemistry pairings:** Gabe’s 800 W Blade plan combines a fresh 13s5p LG MH1 block with a 3s6p stack of retired EVE ES2 cells to stretch range; treat that as a low-amp experiment, log temps, and expect sag differences compared with the P42A packs he reserves for dual 22×3 80100 race builds.【F:data/vesc_help_group/text_slices/input_part007.txt†L495-L599】
- **Know platform limits.** Xiaomi Mi 3/Mi 4 scooters ship with locked firmware, top-entry decks, and warranty-sensitive hardware, so most modders stick with the older Pro series when they need deep battery or controller swaps.【F:knowledge/notes/input_part007_review.md†L513-L513】
- **Brake planning:** 12 S conversions hit ~40 km/h on flat ground—upgrade mechanical brakes and keep regen under ~20 A so Rita and controller FETs stay alive.【F:knowledge/notes/all_part01_review.md†L44-L44】【F:knowledge/notes/all_part01_review.md†L79-L80】
- **Controller heat path:** Torque down stock controllers flush to the chassis with fresh thermal paste; loose mounting or cable stacks overheat MOSFETs on the first long ride.【F:knowledge/notes/denis_all_part02_review.md†L140-L141】
- **Parallel etiquette:** Only parallel packs with matched voltages and common-port BMS boards—Rita and Happy both block or fault when faced with mismatched hardware.【F:knowledge/notes/all_part01_review.md†L102-L113】【F:knowledge/notes/denis_all_part02_review.md†L64-L65】【F:knowledge/notes/denis_all_part02_review.md†L532-L532】
- **Never tie 48 V and 36 V packs directly together.** The workshop treats Rita as the only safe bridge—direct paralling dumps current violently and risks pack fires.【F:knowledge/notes/denis_all_part02_review.md†L508-L508】
- **LiPo discipline:** RC LiPo bricks puff when stored at full charge and develop high internal resistance within days—treat them as short-term boosters, not daily commuter batteries.【F:knowledge/notes/denis_all_part02_review.md†L158-L159】
- **Respect BMS ceilings.** Even 80 A-capable cells sag and trip protection if the pack still uses a 40 A BMS—raise ratings alongside parallel count to avoid false cut-outs.【F:knowledge/notes/all_part01_review.md†L93571-L93578】
- **Respond quickly to regen-induced faults.** A regen-heavy stop without Rita scorched a customer’s BMS and controller—disconnect immediately, recharge sub-2 V cells individually, and tidy sloppy sensor wiring before condemning hardware.【F:knowledge/notes/all_part01_review.md†L157-L157】
- **Treat headlight-triggered brownouts as BMS clues.** If toggling lights kills the dash or cuts throttle, test with a known-good pack, inspect every parallel group, and replace fuses before blaming the scooter electronics.【F:knowledge/notes/all_part01_review.md†L158-L158】
- **Environmental prep:** Seal deck seams, cable ports, and hub joints with silicone plus lithium grease; add humidity sensors or alarms if you commute in heavy rain.【F:knowledge/notes/all_part01_review.md†L41-L41】【F:knowledge/notes/all_part01_review.md†L86-L88】

### Sleeper Packaging Templates
- **Xiaomi Pro 2 20 S sleeper layout.** Gabe splits the 20 S 8 P pack between the deck and an external bag, prints 35–36 mm spacers, reroutes phase cables, and trims foam so dual controllers coexist without killing ground clearance—document the weight distribution before copying the build.【F:knowledge/notes/input_part007_review.md†L514-L514】

## Commissioning Checklist
1. **Balance & inspect cells** before closing the pack, replacing entire groups rather than mixing fresh with aged cells.【F:knowledge/notes/all_part01_review.md†L10-L11】【F:knowledge/notes/denis_all_part02_review.md†L67-L68】
2. **Update firmware and dashboards** with BLE downgrades, ST-Link backups, and Rita/Happy configuration before connecting higher-voltage packs.【F:knowledge/notes/all_part01_review.md†L46-L49】【F:knowledge/notes/all_part01_review.md†L119-L119】
3. **Set conservative current limits:** cap battery current ≈25–28 A, regen below 20 A, and confirm logs show <30 A through Rita or Happy BMS during shakedowns.【F:knowledge/notes/all_part01_review.md†L79-L81】【F:knowledge/notes/denis_all_part02_review.md†L55-L57】
4. **Validate charging paths**—meter chargers after resistor swaps, confirm Happy BMS accepts the amperage limit you expect, and never rely on charge-port power for accessories.【F:knowledge/notes/all_part01_review.md†L221-L224】【F:knowledge/notes/denis_all_part02_review.md†L476-L477】【F:knowledge/notes/denis_all_part02_review.md†L70-L71】
5. **Log first rides** with m365Tools or XiaoDash, watching pack temperature, voltage sag, and current spikes so you can dial back settings before hardware fails.【F:knowledge/notes/all_part01_review.md†L105-L105】【F:knowledge/notes/denis_all_part02_review.md†L55-L57】
